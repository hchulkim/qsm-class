% Options for packages loaded elsewhere
% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  11pt]{article}
\usepackage{xcolor}
\usepackage{amsmath,amssymb}
\setcounter{secnumdepth}{5}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother


\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother





\setlength{\emergencystretch}{3em} % prevent overfull lines

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}



 
\usepackage[]{natbib}
\bibliographystyle{econ}


\usepackage{graphicx}
\usepackage{bbm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage[nomarginpar]{geometry}
\usepackage{setspace}
\usepackage{natbib}
\usepackage{lscape}
\usepackage{rotating}
\usepackage{tabularx, calc}
\usepackage{threeparttable}
\usepackage{picinpar}  
\usepackage{longtable}
\usepackage{ae}
\usepackage{float}
\usepackage{morefloats}
\usepackage{palatino}
\usepackage{hyperref}
\usepackage{color}
\usepackage{adjustbox}
\usepackage{booktabs} 
\usepackage{ulem}
\usepackage{ragged2e}
\usepackage{changepage}
\usepackage{longtable}
%\usepackage{graphics}
%\usepackage[tableposition=top]{caption}

\geometry{left=1.0in,right=1.0in,top=1.0in,bottom=1.0in}
\onehalfspacing
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Coding assignment (QSM class)},
  pdfauthor={Hyoungchul Kim},
  colorlinks=true,
  linkcolor={cyan},
  filecolor={Maroon},
  citecolor={cyan},
  urlcolor={cyan},
  pdfcreator={LaTeX via pandoc}}


\title{Coding assignment (QSM class)}
\author{Hyoungchul Kim}
\date{September 10, 2025}
\begin{document}
\def\spacingset#1{\renewcommand{\baselinestretch}%
{#1}\small\normalsize} \spacingset{1}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\date{\href{https://github.com/hchulkim/qsm-class/blob/main/output/output.pdf}{Link to Latest version}\\ \vspace{1em}  Last updated September
10, 2025}
\title{Coding assignment (QSM class)\thanks{I acknowledge that I worked
with Coni, Yuxuan, and Eni. I also acknowledge that I used
\citet{chatgpt} and \citet{cursor} to help me with the coding. They were
mostly used for debugging and auto-completion. Thus, the main structure
of the code was all written by the author. All the codes were later
reviwed and finalized by the author.}}
\author{
Hyoungchul Kim\thanks{email: hchulkim@wharton.upenn.edu}\\
The Wharton School, University of Pennsylvania\\
}
\maketitle

\bigskip
\bigskip
\begin{abstract}
This is a coding assignment for the QSM class.
\end{abstract}

\bigskip

\newpage
\spacingset{1.2} % DON'T change the spacing!

\section{Use of programming
language}\label{sec-use-of-programming-language}

For questions 1-7, I used \texttt{R} programming language. I also used
\texttt{R} for most of the data cleaning and manipulation. For other
questions that requires more computationally intensive analyses
(modeling, etc.), I used \texttt{julia} programming language.

\section{Main data information}\label{sec-main-data-info}

I am using the 2022 LODES data from LEHD for my analysis. I obtained the
raw data for Philadelphia county from the LEHD website and aggregated
the data into tract-tract level. The process of cleaning the raw data
was conducted using the source code:
\texttt{src/R/01\_clean\_raw\_data.R}.

My primary analysis zone will be bilateral commuting flow within
Philadelphia county for the year 2022. This means I will not be
considering the flow where either the origin or the destination is
outside of Philadelphia county.

\subsection*{Q1}\label{q1}
\addcontentsline{toc}{subsection}{Q1}

As I mentioned in Section~\ref{sec-main-data-info}, I obtained bilateral
commuting flow data from LEHD LODES for the year 2022. I also downloaded
supporting data on the locations of the tracts or blocks underlying the
data. I downloaded them in the \texttt{input} folder. You can also use
\texttt{make\ raw} command to automatically download the raw
data.\footnote{Note that if you want to re-download the raw data, you
  must first use \texttt{make\ clean\_raw} command to remove the raw
  data in the \texttt{input} folder. Also note that if the original data
  was updated during the course of the semester, there is a likelihood
  that the new downloaded data might have different data structure that
  could affect the analysis.}

\subsection*{Q2}\label{q2}
\addcontentsline{toc}{subsection}{Q2}

For distance, I will use the distance between the centroids of the
origin and destination tracts. For this, I used \texttt{sf} package and
\texttt{tigris} package in R to calculate the distance between the
centroids of the origin and destination tracts. The source code is
available in \texttt{src/R/02\_calculate\_distance.R}. I also retained
the fixed effects estimates in the Appendix.

\subsection*{Q3}\label{q3}
\addcontentsline{toc}{subsection}{Q3}

I estimated the following linear model:

\[
\log(N_{ij}) = \theta_{i} + \lambda_{j} - \epsilon \kappa d_{ij} + e_{ij}\label{eq:distance}
\]

The estimation results are reported in the following table:

\clearpage

\begin{table}[!ht]
\centering
\caption{Estimation results}
\label{tab:est_results}
\input{tables/q3_linear_model.tex}
\end{table}

\footnotesize \textbf{Note}: This table presents estimation result of
the equation \ref{eq:distance}. \texttt{distance\_km} is the estimate of
the \(-\epsilon\kappa\). The value in the paranthesis is standard
error.\vspace{3em}

\normalsize

\section*{Q4}\label{q4}
\addcontentsline{toc}{section}{Q4}

After including all the \(ij\) pairs and adding in zero commuting flows,
I estimated the PPML model as follows:

\[
\log(\mathbb{E}[N_{ij}])= \theta_{i} + \lambda_{j} - \epsilon \kappa d_{ij} + e_{ij}\label{eq:ppml}
\]

The estimation results are reported in the following table (I also
retained the fixed effects estimates in the
\texttt{input/q4\_ppml\_fes.csv}):

\begin{table}[!ht]
\centering
\caption{Estimation results of the PPML model}
\label{tab:est_ppml}
\input{tables/q4_ppml.tex}
\end{table}

\footnotesize \textbf{Note}: This table presents estimation result of
the equation \ref{eq:ppml}. \texttt{distance\_km} is the estimate of the
\(-\epsilon\kappa\). The value in the paranthesis is standard
error.\vspace{3em}

\normalsize

We can clearly see that the estimate of the \(-\epsilon\kappa\) differs
from the estimate in the previous question. The absolute size of the
estimate is larger in the PPML model. Intuitively, I think this occurs
because the PPML model incorporates the zero commuting flows that were
neglected in the linear model. Since the zero commuting flows were not
fully incorporated in the linear model, the estimate in the linear model
was underestimating the effect of the travel-time cost on the commuting
flow. The estimate in the PPML model shifts downward to account for the
zero commuting flows.

Something to note is that in PPML, FEs are not always identified. In our
case, two FEs are not identified because there is no flow for any
tract-tract pair.

\section*{Q5}\label{q5}
\addcontentsline{toc}{section}{Q5}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  For \(ii\) pairs, we could add minimum distance from the centroid to
  the edge of the polygon geometry as the distance measure. While this
  is not a perfect measure, it still should work as a proxy for
  measuring the relative size of certain distance from traveling within
  the same tract. This also solves the zero distance issue. The only
  problem might be that this method could be bit ad-hoc and not
  consistent as we are just adding additional values only onto the
  \(ii\) pairs and not consider the \(ij\) pairs.
\end{enumerate}

Using this method, I get the following estimates for linear and PPML
models:

\begin{table}[!ht]
\centering
\caption{Estimation results of the linear model for $ii$ pairs}
\label{tab:est_linear_ii}
\input{tables/q5_linear_model_solution1.tex}
\end{table}

\begin{table}[!ht]
\centering
\caption{Estimation results of the PPML model for $ii$ pairs}
\label{tab:est_ppml_ii}
\input{tables/q5_ppml_model_solution1.tex}
\end{table}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Another way would be to change the definition of the distance measure
  so that \(ii\) pairs will not have zero values. We leverage the fact
  that our data can become more granular. That is, we have information
  on the longitude and latitude of the centroid of the census block.
  After calculating the distance between two centroids of the census
  blocks, we can use mean of the all the block-level distances within
  the same tract-tract pair as the distance measure of the tract-tract
  pairs. This will give us non-zero distance for \(ii\) pairs.
\end{enumerate}

Using this method, I get the following estimates for linear and PPML
models:

\begin{table}[!ht]
\centering
\caption{Estimation results of the linear model for $ii$ pairs}
\label{tab:est_linear_ii_2}
\input{tables/q5_linear_model_solution2.tex}
\end{table}

\begin{table}[!ht]
\centering
\caption{Estimation results of the PPML model for $ii$ pairs}
\label{tab:est_ppml_ii_2}
\input{tables/q5_ppml_model_solution2.tex}
\end{table}

You can see that the estimates are very similar to the estimates in the
previous question. This suggests that perhaps the zero distance issue is
not a major issue in the analysis.

\section*{Q6}\label{q6}
\addcontentsline{toc}{section}{Q6}

\clearpage

\section*{Q7}\label{q7}
\addcontentsline{toc}{section}{Q7}

My code in \texttt{src/R/07\_create\_market\_access.R} creates the
market access variable. For each residential and workplace tract, I
calculate the market access variable using the definition in the
question. I posted the result in the Appendix. In the main document, I
will plot the map of the market access variable.

\begin{figure}

\begin{minipage}{0.50\linewidth}

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{figures/residential_market_access.png}}

}

\subcaption{\label{fig-residential-market-access}Map of the residential
market access}

\end{minipage}%
%
\begin{minipage}{0.50\linewidth}

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{figures/workplace_market_access.png}}

}

\subcaption{\label{fig-workplace-market-access}Map of the workplace
market access}

\end{minipage}%

\end{figure}%

\footnotesize \textbf{Note}: This is the map (Philadelphia county) of
the market access variable. The color represents the market access
variable. The lighter the color, the higher the market access. The
values are normalized (z-score).

\normalsize

\clearpage

\section*{Q8}\label{q8}
\addcontentsline{toc}{section}{Q8}

I use two scripts to accomplish this. For data manipulation stage I use
\texttt{src/R/08\_fixed\_point\_algorithm.R} to create the sum of
bilateral commuting flow and the expotential terms. For implementing
fixed point algorithm, I use
\texttt{src/julia/08\_fixed\_point\_algorithm.jl}.

I plot the map of the market access again below:

\begin{figure}

\begin{minipage}{0.50\linewidth}

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{figures/residential_market_access_fixed_point.png}}

}

\subcaption{\label{fig-residential-market-access-fixed-point}Map of the
residential market access}

\end{minipage}%
%
\begin{minipage}{0.50\linewidth}

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{figures/workplace_market_access_fixed_point.png}}

}

\subcaption{\label{fig-workplace-market-access-fixed-point}Map of the
workplace market access}

\end{minipage}%

\end{figure}%

\footnotesize \textbf{Note}: This is the map (Philadelphia county) of
the market access variable. The color represents the market access
variable. The lighter the color, the higher the market access. The
values are normalized (z-score).

\normalsize

\section*{Q9}\label{q9}
\addcontentsline{toc}{section}{Q9}

While the level of the market access variable differs, the overall
distribution of the market access variable is similar. That is, the
ordinality of the market access variable is preserved for both cases.
This result is consistent with the derivation of the market access
equation we learned in class. To be specific, we discussed in page 21 of
the week1-lecture 1 that the equations in Q8 and Q9 are equivalent way
to derive market access variable. While the level of the market access
variable could differ, the ordinality of the market access variable
should be similar.

\section*{Q10}\label{q10}
\addcontentsline{toc}{section}{Q10}

Following Apppendix F of \citet{brinkman2024}, I need to create a fixed
point algorithm to solve for the following equation\footnote{I tweaked
  the equation from the paper to make it more clear for the matrix
  muliplication process I will be using below.}. (We will assume that
there are total \(J\) workplace tracts and \(I\) residential tracts.
While the number of tracts is same, we just use separate indices for
them to make it more clear in the equation.):

\begin{align*}
  \omega_j = \left( \frac{1}{N_{Wj}} \left[\sum_i \left( N_{Ri} \cdot d_{ij}^{-\epsilon}\right) \left[\sum_{j'} \left( w_{j'}^\epsilon \cdot d_{ij'}^{-\epsilon} \right)\right]^{-1}\right] \right)^{-\frac{1}{\epsilon}}
\end{align*}

I use the following matrix multiplication to setup the fixed point
algorithm (\(\omega = T(\omega)\)):

\begin{align*}
  \underbrace{
  \begin{bmatrix}
    \omega_1 \\
    \omega_2 \\
    \vdots \\
    \omega_J
  \end{bmatrix}}_{J \times 1}
  = &
  \overbrace{
  \begin{bmatrix}
    \left(\frac{1}{N_{W1}} \cdot N_{R1} \cdot d_{11}^{-\epsilon}\right) & \left(\frac{1}{N_{W1}} \cdot N_{R2} \cdot d_{21}^{-\epsilon}\right) & \ldots & \left(\frac{1}{N_{W1}} \cdot N_{RJ} \cdot d_{J1}^{-\epsilon}\right) \\
    \left(\frac{1}{N_{W2}} \cdot N_{R1} \cdot d_{12}^{-\epsilon}\right) & \left(\frac{1}{N_{W2}} \cdot N_{R2} \cdot d_{22}^{-\epsilon}\right) & \ldots \\
    \vdots & \vdots & \ddots \\
    \left(\frac{1}{N_{WJ}} \cdot N_{R1} \cdot d_{1J}^{-\epsilon}\right) & \left(\frac{1}{N_{WJ}} \cdot N_{R2} \cdot d_{2J}^{-\epsilon}\right) & \ldots & \left(\frac{1}{N_{WJ}} \cdot N_{RJ} \cdot d_{JJ}^{-\epsilon}\right) \\
  \end{bmatrix}}^{J \times I} \times \\ 
  &\underbrace{
  \begin{bmatrix}
    d_{11}^{-\epsilon} & d_{12}^{-\epsilon} & \ldots & d_{1J}^{-\epsilon} \\
    d_{21}^{-\epsilon} & d_{22}^{-\epsilon} & \ldots & d_{2J}^{-\epsilon} \\
    \vdots & \vdots & \ddots \\
    d_{I1}^{-\epsilon} & d_{I2}^{-\epsilon} & \ldots & d_{IJ}^{-\epsilon} \\
  \end{bmatrix}}_{I \times J} \times 
  \underbrace{
  \left(\begin{bmatrix}
    \omega_1 \\
    \omega_2 \\
    \vdots \\
    \omega_J
  \end{bmatrix}\right)^{\epsilon}}_{J \times 1}
\end{align*}

For convenience, I did not put the power of the \(-\frac{1}{\epsilon}\)
in the equation above. Also note that I also did not inverse the rows of
the matrix after the multiplication of \(I \times J\) and
\(J \times 1\). I will add them in the fixed point algorithm.

After retrieving the wages for each location, the rest is pretty
straightforward. This is because we no longer have the iterative
equations. We can just solve for the land rents, neighborhood amenities
and productivities using the equations in the Appendix F of
\citet{brinkman2024}.

I plot the map of the land rents in the following figure (Note that I
z-scored land rents and then used \texttt{asinh} transformation to make
the map more readable. This is because the land rents are very skewed
for certain tracts so raw values for other tracts become
indistinguishable in the map):

\clearpage

\begin{figure}

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{figures/land_rent.png}}

}

\caption{\label{fig-land-rent}Map of the land rents}

\end{figure}%

\footnotesize \textbf{Note}: This is the map (Philadelphia county) of
the land rents. The color represents the land rents. The lighter the
color, the higher the land rents. The values are normalized (z-score)
and then transformed using \texttt{asinh} transformation to make the map
more readable. The grey areas are tracts which we cannot recover the
land rents as there is no flow for them.\vspace{2em}

\normalsize

It is hard to say whether the land rents are reasonable or not but my
thoughts are that the results are not doing a good job of accurately
recovering the actual land rents. While the results seem to correctly
hint that regions near the center of the city have higher land rents,
this is also not very accurate as tracts that are more close to the
center of the city have lower land rents. According to some anecdotal
evidence, the land rents of the center of the city should be the highest
and the southern part of Philadelphia also should have relatively higher
land rents. These anecdotal evidence do not seem to be well captured by
the results.

One of the reasons why the results are not very accurate could be
because of the simplifying assumptions we made. For example, we assumed
that the land area is the same for all tracts. This is of course not the
accurate depiction of the actual land areas of the tracts in
Philadelphia county. I am also using tract-tract centroid distance as
the measure for the travel time cost. This might not be accurate as
perhaps there are certain factors that significantly affect the travel
time that the actual travel time differs from the centroid distance.
Thus, these simplifying assumptions might be leading to a more less
accurate results.

Another possible reason is that maybe the inversion process is not doing
a very good job of recovering the actual land rents. In
\citet{brinkman2024}, they use Chicago metropolitan area as their data
for the inversion process. It might be that the model is not well-suited
for Philadelphia county. For example, the paper mentions that Chicago
provides a good setting given that it exhibits relatively centralized
employment and has relatively homogeneous topography. While this also
seems to be true for Philadelphia county, perhaps there are some
differences that make the model not well-suited for Philadelphia county.

\clearpage

\subsection*{References}\label{references}
\addcontentsline{toc}{subsection}{References}

\renewcommand{\bibsection}{}
\bibliography{bibliography.bib}

\clearpage

\phantomsection\label{appendix}
\bigskip

\begin{center}

{\large\bf APPENDIX}

\end{center}

\subsubsection*{A. Residential market
access}\label{a.-residential-market-access}
\addcontentsline{toc}{subsubsection}{A. Residential market access}

\input{tables/residential_market_access.tex}

\clearpage

\subsubsection*{B.Workplace market
access}\label{b.workplace-market-access}
\addcontentsline{toc}{subsubsection}{B.Workplace market access}

\input{tables/workplace_market_access.tex}





\end{document}
