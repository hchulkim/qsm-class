---
title: Coding assignment (QSM class)
format:
  aea-pdf:
    keep-tex: true  
    journal:
      blinded: false
    indent: true
    citecolor: cyan
    linkcolor: cyan
    urlcolor: cyan
  aea-html: default
title-footnote: |
  Some footnotes on the title...
author-format: horizontal
author:
  - name: Hyoungchul Kim
    acknowledgements: | 
      The creator. We want to thank...
    affiliations:
      - name: The Wharton School, University of Pennsylvania
date: last-modified
articleurl: https://hchulkim.github.io
abstract: |
  This is a coding assignment for the QSM class.
bibliography: bibliography.bib  
---

# Use of programming language {#sec-use-of-programming-language}

For questions 1-6, I used `R` programming language. I also used `R` for most of the data cleaning and manipulation. For other questions that requires more computational intensive analyses (modeling, etc.), I used `julia` programming language.

# Main data information {#sec-main-data-info}

I am using the 2022 LODES data from LEHD for my analysis. I obtained the raw data for Philadelphia county from the LEHD website and aggregated the data into tract-tract level. The process of cleaning the raw data was conducted using the source code: `src/R/01_clean_raw_data.R`.

Thus my primary analysis zone will be bilateral commuting flow within Philadelphia county for the year 2022. This means I will not be considering the flow where either the origin or the destination is outside of Philadelphia county.

## Q1 {.unnumbered}

As I mentioned in @sec-main-data-info, I obtained bilateral commuting flow data from LEHD LODES for the year 2022. I also downloaded supporting data on the locations of the tracts or blocks underlying the the data. I downloaded them in the `input` folder. You can also use `make raw` command to automatically download the raw data.[^1]

[^1]: Note that if you want to re-download the raw data, you must first use `make clean` command to remove the raw data in the `input` folder. Also note that if the original data was updated during the course of the semester, there is a likelihood that the new downloaded data might have different data structure that could affect the analysis.

## Q2 {.unnumbered}

For distance, I will use the distance between the centroids of the origin and destination tracts. For this, I used `sf` package and `tigris` package in R to calculate the distance between the centroids of the origin and destination tracts. The source code is available in `src/R/02_calculate_distance.R`. I also retained the fixed effects estimates in the Appendix.

## Q3 {.unnumbered}

I estimated the following linear model:

$$
\log(N_{ij}) = \theta_{i} + \lambda_{j} - \epsilon \kappa d_{ij} + e_{ij}\label{eq:distance}
$$

The estimation results are reported in the following table:

\clearpage

\begin{table}[!ht]
\centering
\caption{Estimation results}
\label{tab:est_results}
\input{tables/q3_linear_model.tex}
\end{table}
\footnotesize \textbf{Note}: This table presents estimates results of the equation \ref{eq:distance}. `distance_km` is the estimates of the semi-elasticity of the travel time (or distance). The values in the paranthesis in the table is the standard error.\vspace{3em}

\normalsize

You can see that the estimates of the semi-elasticity of the travel time (or distance) is sensible as it is negative (-0.07). This indicates that the travel time (or distance) has a negative correlation with the commuting flow.

# Q4 {.unnumbered}

After including all the $ij$ pairs and adding in zero commuting flows, I estimated the PPML model as follows:

$$
\log(\mathbb{E}[N_{ij}])= \theta_{i} + \lambda_{j} - \epsilon \kappa d_{ij} + e_{ij}\label{eq:ppml}
$$

The estimation results are reported in the following table (I also retained the fixed effects estimates in the Appendix):

\begin{table}[!ht]
\centering
\caption{Estimation results of the PPML model}
\label{tab:est_ppml}
\input{tables/q4_ppml.tex}
\end{table}
\footnotesize \textbf{Note}: This table presents estimates results of the equation \ref{eq:ppml}. `distance_km` is the estimates of the semi-elasticity of the travel time (or distance). The values in the paranthesis in the table is the standard error.\vspace{3em}

\normalsize

We can clearly see that the etimates of the semi-elasticity of the distance differs from the estimates in the previous question. The absolute size of the estimates is larger in the PPML model. Intuitively, I think this occurs because the PPML model incorporates the zero commuting flows that were neglected in the linear model. Since the zero commuting flows were not fully incorporated in the linear model, the estimates in the linear model were underestimating the effect of the travel-time cost on the commuting flow. 

# Q5 {.unnumbered}

1. For $ii$ pairs, we could add minimum distance from the centroid to the edge of the polygon geometry as the distance measure. While this is not a perfect measure, it still should work as a proxy for measuring the relative size of certain distance from traveling within the same tract. This also solves the zero distance issue. The only problem might be that this method could be bit ad-hoc and not consistent as we are just additional additional values only onto the $ii$ pairs and not consider the $ij$ pairs.

Using this method, I get the following estimates for linear and PPML models:

2. Another way would be to change the definition of the distance measure so that $ii$ pairs will not have zero values. We leverage the fact that our data can become more granular. That is, we have information on the longitude and latitude of the centroid of the census block. After calculating the distance between two centroids of the census blocks, we can use mean of the all the block-level distances within the same tract-tract pair as the distance measure of the tract-tract pairs. This will give us non-zero distance for $ii$ pairs.

Using this method, I get the following estimates for linear and PPML models:

# Q6 {.unnumbered}

\clearpage

# Q7 {.unnumbered}

My code in `src/R/07_create_market_access.R` creates the market access variable. For each residential and workplace tract, I calculate the market access variable using the definition in the question. I posted the result in the Appendix. In the main document, I will plot the map of the market access variable.

::: {#fig-market-access layout-ncol=2 layout="[50, 50]"}

![Map of the residential market access](figures/residential_market_access.png){#fig-residential-market-access}

![Map of the workplace market access](figures/workplace_market_access.png){#fig-workplace-market-access}

:::


\footnotesize \textbf{Note}: This is the map (Philadelphia county) of the market access variable. The color represents the market access variable. The lighter the color, the higher the market access. The values are normalized (z-score) to be between 0 and 1.

\normalsize

\clearpage

# Q8 {.unnumbered}

I use two scripts to accomplish this. For data manipulation stage I use `src/R/08_fixed_point_algorithm.R` to create the sum of bilateral commuting flow and the expotential terms. For implementing fixed point algorithm, I use `src/julia/08_fixed_point_algorithm.jl`.

I plot the map of the market access again below:


::: {#fig-market-access-fixed-point layout-ncol=2 layout="[50, 50]"}

![Map of the residential market access](figures/residential_market_access_fixed_point.png){#fig-residential-market-access-fixed-point}

![Map of the workplace market access](figures/workplace_market_access_fixed_point.png){#fig-workplace-market-access-fixed-point}

:::

\footnotesize \textbf{Note}: This is the map (Philadelphia county) of the market access variable. The color represents the market access variable. The lighter the color, the higher the market access. The values are normalized (z-score) to be between 0 and 1.

\normalsize

# Q9 {.unnumbered}

While the level of the market access variable differs, the overall distribution of the market access variable is similar. That is, the ordinality of the market access variable is preserved for both cases. This result is consistent with the derivation of the market access equation from the economic theory.

# Q10 {.unnumbered}

Following Apppendix F of @brinkman2024, I need to create a fixed point algorithm to solve for the following equation[^2]. (We will assume that there are total $J$ workplace tracts and $I$ residential tracts. While the number of tracts is same, we just use separate indices for them to make it more clear in the equation.):

\begin{align*}
  \omega_j = \left( \frac{1}{N_{Wj}} \left[\sum_i \left( N_{Ri} \cdot d_{ij}^{-\epsilon}\right) \left[\sum_{j'} \left( w_{j'}^\epsilon \cdot d_{ij'}^{-\epsilon} \right)^{-1}\right]\right] \right)^{-\frac{1}{\epsilon}}
\end{align*}

[^2]: I tweaked the equation from the paper to make it more clear for the matrix muliplication process I will be using below. 

I use the following matrix multiplication to setup the fixed point algorithm ($\omega = T(\omega)$):

\begin{align*}
  \underbrace{
  \begin{bmatrix}
    \omega_1 \\
    \omega_2 \\
    \vdots \\
    \omega_J
  \end{bmatrix}}_{J \times 1}
  = &
  \overbrace{
  \begin{bmatrix}
    \left(\frac{1}{N_{W1}} \cdot N_{R1} \cdot d_{11}^{-\epsilon}\right) & \left(\frac{1}{N_{W1}} \cdot N_{R2} \cdot d_{21}^{-\epsilon}\right) & \ldots & \left(\frac{1}{N_{W1}} \cdot N_{RJ} \cdot d_{J1}^{-\epsilon}\right) \\
    \left(\frac{1}{N_{W2}} \cdot N_{R1} \cdot d_{12}^{-\epsilon}\right) & \left(\frac{1}{N_{W2}} \cdot N_{R2} \cdot d_{22}^{-\epsilon}\right) & \ldots \\
    \vdots & \vdots & \ddots \\
    \left(\frac{1}{N_{WJ}} \cdot N_{R1} \cdot d_{1J}^{-\epsilon}\right) & \left(\frac{1}{N_{WJ}} \cdot N_{R2} \cdot d_{2J}^{-\epsilon}\right) & \ldots & \left(\frac{1}{N_{WJ}} \cdot N_{RJ} \cdot d_{JJ}^{-\epsilon}\right) \\
  \end{bmatrix}}^{J \times I} \times \\ 
  &\underbrace{
  \begin{bmatrix}
    d_{11}^{-\epsilon} & d_{12}^{-\epsilon} & \ldots & d_{1J}^{-\epsilon} \\
    d_{21}^{-\epsilon} & d_{22}^{-\epsilon} & \ldots & d_{2J}^{-\epsilon} \\
    \vdots & \vdots & \ddots \\
    d_{I1}^{-\epsilon} & d_{I2}^{-\epsilon} & \ldots & d_{IJ}^{-\epsilon} \\
  \end{bmatrix}}_{I \times J} \times 
  \underbrace{
  \begin{bmatrix}
    \omega_1 \\
    \omega_2 \\
    \vdots \\
    \omega_J
  \end{bmatrix}}_{J \times 1}
\end{align*}

For convenience, I did not put the power of the $-\frac{1}{\epsilon}$ in the equation above. Also note that I also did not inverse the rows of the matrix after the multiplication of $I \times J$ and $J \times 1$. I will add them in the fixed point algorithm.

After retrieving the wages for each location, the rest is pretty straightforward. This is because we no longer have the iterative equations. We can just solve for the land rents, neighborhood amenities and productivities using the equations in the Appendix F of @brinkman2024.

I plot the map of the land rents in the following figure:

\clearpage

## References {.unnumbered}

::: {#refs}
:::

\clearpage

## Appendix {.supplementary}

### A. Residential market access {.unnumbered}

\input{tables/residential_market_access.tex}

\clearpage

### B.Workplace market access {.unnumbered}

\input{tables/workplace_market_access.tex}


